{% extends 'base.html' %}

{% block title %}Dashboard - Freezehouse{% endblock %}

{% block content %}
<div class="container">
  <h2>Welcome, {{ current_user.username }}</h2>

  <h3>Book Appointment</h3>
  <form method="POST" id="booking-form">
    <label for="date">Date:</label>
    <input type="date" name="date" id="date" required>

    <label for="time">Time:</label>
    <select name="time" id="time" required>
      <option value="">Select a Time</option>
      {% for hour in range(9, 22) %}
        {% set hour12 = hour if hour <= 12 else hour - 12 %}
        {% set suffix = "AM" if hour < 12 else "PM" %}
        {% set time_val = "%02d:00"|format(hour) %}
        <option value="{{ time_val }}">{{ "%02d:00"|format(hour12) }} {{ suffix }}</option>
      {% endfor %}
    </select>

    <label for="reason">Reason:</label>
    <textarea name="reason" id="reason" placeholder="Reason" required></textarea>

    <label for="bath_type">Bath Type:</label>
    <select name="bath_type" id="bath_type" required>
      {% for bath in bath_types %}
        <option value="{{ bath.name }}">{{ bath.name }} - ‚Çπ{{ bath.price }}</option>
      {% endfor %}
    </select>

    <button type="submit" class="btn">Book</button>
  </form>

  <h3>Your Appointments</h3>
  <ul class="card-list">
    {% for appointment in appointments %}
    <li class="card">
      <strong>{{ appointment.date }} at {{ appointment.time }}</strong><br>
      {{ appointment.reason }} | {{ appointment.bath_type }} | ‚Çπ{{ appointment.price }}<br>
      <a href="{{ url_for('reschedule_appointment', id=appointment.id) }}">‚úèÔ∏è Reschedule</a>
      &nbsp; | &nbsp;
      <a href="{{ url_for('delete_appointment', id=appointment.id) }}" onclick="return confirm('Are you sure?')">üóëÔ∏è Delete</a>
    </li>
    {% else %}
    <li>No appointments yet.</li>
    {% endfor %}
  </ul>

  <p><a href="{{ url_for('logout') }}" class="btn" style="margin-top: 20px; display: inline-block;">Logout</a></p>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="{{ url_for('static', filename='js/particles-config.js') }}"></script>

<script>
  const bookedSlots = {{ booked_slots | tojson | safe }};
  const timeSelect = document.getElementById("time");
  const dateInput = document.getElementById("date");

  dateInput.addEventListener("change", function () {
    const selectedDate = this.value;
    const takenTimes = bookedSlots
      .filter(slot => slot[0] === selectedDate)
      .map(slot => slot[1]);

    [...timeSelect.options].forEach(opt => {
      if (opt.value && takenTimes.includes(opt.value)) {
        opt.disabled = true;
        opt.textContent = opt.value + " (Booked)";
      } else {
        opt.disabled = false;
        opt.textContent = opt.textContent.replace(" (Booked)", "");
      }
    });
  });

  // Block past dates
  const today = new Date().toISOString().split('T')[0];
  dateInput.setAttribute('min', today);
</script>
{% endblock %}
