{% extends 'base.html' %}

{% block title %}Dashboard - Freezehouse{% endblock %}

{% block content %}
<div class="container">
  <h2>Welcome, {{ current_user.username }}</h2>

  <h3>Book Appointment</h3>
  <form method="POST" id="booking-form">
    <label for="date">Date:</label>
    <input type="date" name="date" id="date" required min="{{ current_date }}">

    <label for="time">Time:</label>
    <select name="time" id="time" required>
      <option value="">Select a Time</option>
      {% for hour in range(9, 21) %}
        {% set hour12 = hour if hour <= 12 else hour - 12 %}
        {% set suffix = "AM" if hour < 12 else "PM" %}
        {% set time_val = "%02d:00"|format(hour) %}
        <option value="{{ time_val }}">{{ "%02d:00"|format(hour12) }} {{ suffix }}</option>
      {% endfor %}
    </select>

    <label for="reason">Reason/Address:</label>
    <textarea name="reason" id="reason" placeholder="Reason/Address" required></textarea>

    <div class="form-group">
  <label for="delivery_option">Service Type:</label>
  <select name="delivery_option" id="delivery_option" class="form-control" required>
    <option value="In-Store">In-Store</option>
    <option value="Home Delivery">Home Delivery</option>
    <option value="Rental">Rental</option>
  </select>
  </div>

    <label for="bath_type">Bath Type:</label>
    <select name="bath_type" id="bath_type" required>
      {% for bath in bath_types %}
        <option value="{{ bath.name }}">{{ bath.name }} - ₹{{ bath.price }}</option>
      {% endfor %}
    </select>

    <button type="submit" class="btn">Book</button>
  </form>

  <h3 style="margin-top: 40px;">Your Appointments</h3>
  <ul class="card-list">
    {% for appointment in appointments %}
      <li class="card">
        <strong>{{ appointment.date }} at {{ appointment.time }}</strong><br>
        {{ appointment.reason }} | {{ appointment.bath_type }} | ₹{{ appointment.price }}<br>
        <a href="{{ url_for('reschedule_appointment', id=appointment.id) }}">✏️ Reschedule</a>
      </li>
    {% else %}
      <li style="margin-top: 10px;">No appointments yet.</li>
    {% endfor %}
  </ul>

  <div style="margin-top: 30px;">
    <a href="{{ url_for('logout') }}" class="btn">Logout</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="{{ url_for('static', filename='js/particles-config.js') }}"></script>

<script>
  const bookedSlots = {{ booked_slots | tojson | safe }};
  const timeSelect = document.getElementById("time");
  const dateInput = document.getElementById("date");

  // Block past dates
  const today = new Date().toISOString().split('T')[0];
  dateInput.setAttribute('min', today);

  dateInput.addEventListener("change", function () {
    const selectedDate = this.value;
    const takenTimes = bookedSlots
      .filter(slot => slot[0] === selectedDate)
      .map(slot => slot[1]);

    [...timeSelect.options].forEach(opt => {
      if (opt.value === "") return;
      if (takenTimes.includes(opt.value)) {
        opt.disabled = true;
        opt.textContent = opt.value + " (Booked)";
      } else {
        opt.disabled = false;
        opt.textContent = opt.value;
      }
    });
  });
</script>
{% endblock %}
