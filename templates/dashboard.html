{% extends 'base.html' %}

{% block title %}Dashboard - Freezehouse{% endblock %}

{% block content %}
<div id="particles-js"></div>
<div class="dashboard">

    <!-- Welcome Section -->
    <div class="welcome-section">
      <h1> Welcome, <span class="user-name">{{ current_user.username }}</span></h1>

  {% if current_user.is_member and current_user.membership_type %}
  <div class="badge-section">
    <img src="{{ url_for('static', filename='img/member.jpg') }}" alt="Member Badge" class="profile-image">
    <p class="membership-line">
      You are a 
      {% if current_user.membership_type == 'Diamond' %}
        <strong style="color: darkblue;">ğŸ’ Diamond Member</strong>
      {% elif current_user.membership_type == 'Platinum' %}
        <strong style="color: teal;">ğŸ† Platinum Member</strong>
      {% elif current_user.membership_type == 'Gold' %}
        <strong style="color: goldenrod;">ğŸ¥‡ Gold Member</strong>
      {% else %}
        <strong>{{ current_user.membership_type }} Member</strong>
      {% endif %}
    </p>
  </div>
{% endif %}


    <!-- Phone Modal -->
    {% if missing_phone %}
    <div class="modal fade" id="phoneModal" tabindex="-1" aria-labelledby="phoneModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('add_phone') }}">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="phoneModalLabel">ğŸ“± Add Your Phone Number</h5>
            </div>
            <div class="modal-body">
              <input type="text" name="phone" class="form-control" placeholder="Enter 10-digit phone number" required pattern="^\d{10}$">
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save Phone</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Booking Form -->
    <div class="card booking-card">
      <h3> Book Appointment :</h3>
      <form method="POST" id="booking-form">
        <div class="form-group">
          <label for="date">ğŸ“† Date:</label>
          <input type="date" name="date" id="date" required class="form-control" min="{{ current_date }}">
        </div>

        <div class="form-group">
          <label for="time">â° Time:</label>
          <select name="time" id="time" required class="form-control">
            <option value="">Select a Time</option>
            {% for hour in range(9, 21) %}
              {% set hour12 = hour if hour <= 12 else hour - 12 %}
              {% set suffix = "AM" if hour < 12 else "PM" %}
              {% set time_val = "%02d:00"|format(hour) %}
              <option value="{{ time_val }}">{{ "%02d:00"|format(hour12) }} {{ suffix }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="gender">ğŸ‘¤ Gender:</label>
          <select name="gender" id="gender" class="form-control" required>
            <option value="" disabled selected>Select your gender</option>
            <option value="Male" {% if current_user.gender == "Male" %}selected{% endif %}>Male</option>
            <option value="Female" {% if current_user.gender == "Female" %}selected{% endif %}>Female</option>
            <option value="Other" {% if current_user.gender == "Other" %}selected{% endif %}>Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="reason">ğŸ“ Address:</label>
          <textarea name="reason" id="reason" class="form-control" placeholder="Enter delivery address..." required></textarea>
        </div>

        <div class="form-group">
          <label for="delivery_option">ğŸšš Service Type:</label>
          <select name="delivery_option" id="delivery_option" class="form-control" required>
            <option value="In-Store">In-Store</option>
            <option value="Home Delivery">Home Delivery</option>
            <option value="Rental">Rental</option>
          </select>
        </div>

        <div class="form-group">
          <label for="bath_type">ğŸ› Bath Type:</label>
          <select name="bath_type" id="bath_type" class="form-control" required>
            {% for bath in bath_types %}
              <option value="{{ bath.name }}">{{ bath.name }} - â‚¹{{ bath.price }}</option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Book Appointment</button>
      </form>
    </div>

    <!-- Appointments List -->
    <div class="card appointments-card">
      <h3>ğŸ“œ Your Appointments</h3>
      {% if appointments %}
      <ul class="card-list">
        {% for appointment in appointments %}
          <li class="appointment-card">
            <div><strong>{{ appointment.date }} at {{ appointment.time }}</strong></div>
            <div>{{ appointment.reason }} | {{ appointment.bath_type }} | â‚¹{{ appointment.price }}</div>
            <a href="{{ url_for('reschedule_appointment', id=appointment.id) }}" class="btn-link">âœï¸ Reschedule</a>
          </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No appointments yet.</p>
      {% endif %}
    </div>

    <div class="logout-link">
      <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª Logout</a>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="{{ url_for('static', filename='js/particles-config.js') }}"></script>

<!-- Bootstrap modal trigger for phone -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const bookedSlots = {{ booked_slots | tojson | safe }};
  const timeSelect = document.getElementById("time");
  const dateInput = document.getElementById("date");

  const today = new Date().toISOString().split('T')[0];
  dateInput.setAttribute('min', today);

  dateInput.addEventListener("change", function () {
    const selectedDate = this.value;
    const takenTimes = bookedSlots
      .filter(slot => slot[0] === selectedDate)
      .map(slot => slot[1]);

    [...timeSelect.options].forEach(opt => {
      if (opt.value === "") return;
      if (takenTimes.includes(opt.value)) {
        opt.disabled = true;
        opt.textContent = opt.value + " (Booked)";
      } else {
        opt.disabled = false;
        opt.textContent = opt.value;
      }
    });
  });

  {% if missing_phone %}
  const phoneModal = new bootstrap.Modal(document.getElementById('phoneModal'));
  phoneModal.show();
  {% endif %}
</script>
{% endblock %}
